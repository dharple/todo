#!/bin/bash -ex
#
# Simple deployment script
#

DEPLOYUSER=www-data

if [ "$USER" != "$DEPLOYUSER" ] ; then
	sudo -H -u $DEPLOYUSER $0 "$@"
	exit
fi

BASE=$(dirname $(dirname $(realpath $0)))

echo Deploying to $BASE

cd $BASE

git stash save
git pull

if [ -f composer.lock ] ; then
	composer update --no-dev -o
else
	composer install --no-dev -o
fi

if [ -f package-lock.json ] ; then
	npm update
else
	npm install
fi

npm run prod
bin/console cache:clear
bin/console cache:warmup
